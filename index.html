<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, orientation=auto, maximum-scale=1.0, user-scalable=no">
    <title>黄庭禅站桩-计时器</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="./img/icon-128.png" sizes="128x128">
    <link rel="icon" type="image/png" href="./img/icon-192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="./img/icon-512.png" sizes="512x512">
    
    <!-- PWA相关meta标签 -->
    <meta name="theme-color" content="#4fc3f7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="黄庭禅站桩-计时器">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="./img/icon-192.png">
</head>
<body class="portrait">
    <!-- 背景图片容器 -->
    <div class="background-container" id="backgroundContainer"></div>
    <div class="background-overlay" id="backgroundOverlay"></div>
    
    <!-- 计时器容器 -->
    <div class="timer-container">
        <div class="timer-display" id="timerDisplay">00:00</div>
    </div>
    
    <!-- 控制面板 -->
    <div class="control-panel" id="controlPanel">
        <button class="control-btn" id="startPauseBtn">▶️</button>
        <button class="control-btn" id="resetBtn">⏹️</button>
        <button class="control-btn" id="layoutBtn">↕️</button>
        <button class="control-btn" id="settingsBtn">⚙️</button>
        <button class="control-btn" id="helpBtn">❓</button>
    </div>
    
    <!-- 状态指示器 -->
    <div class="status-indicator" id="statusIndicator">准备开始</div>
    
    <!-- 设置面板 -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <div class="settings-title">设置</div>
            <button class="close-settings" id="closeSettings">×</button>
        </div>
        
        <!-- 分页标签 -->
        <div class="settings-tabs">
            <button class="tab-btn active" data-tab="background">背景</button>
            <button class="tab-btn" data-tab="audio">音频</button>
            <button class="tab-btn" data-tab="theme">主题</button>
        </div>
        
        <!-- 背景设置内容 -->
        <div class="settings-content active" id="background-content">
            <div class="settings-section">
                <div class="section-title">背景图片</div>
                
                <div class="setting-item">
                    <span>切换间隔</span>
                    <div class="interval-options">
                        <button class="interval-btn" data-interval="10">10秒</button>
                        <button class="interval-btn" data-interval="30">30秒</button>
                        <button class="interval-btn active" data-interval="60">60秒</button>
                        <div class="custom-interval">
                            <input type="number" id="customIntervalInput" min="5" max="300" placeholder="自定义">
                            <span>秒</span>
                        </div>
                    </div>
                </div>
                
                <div class="setting-item">
                    <span>切换效果</span>
                    <select id="bgEffectSelect">
                        <option value="fade">淡入淡出</option>
                        <option value="slide">滑动</option>
                        <option value="zoom">缩放</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <span>随机播放</span>
                    <input type="checkbox" id="bgRandomCheckbox">
                </div>
                
                <div class="setting-item">
                    <span>图片列表</span>
                    <select id="imageSelect" class="image-select">
                        <option value="">加载中...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- 音频设置内容 -->
        <div class="settings-content" id="audio-content">
            <div class="settings-section">
                <div class="section-title">背景音乐</div>
                
                <div class="setting-item">
                    <span>音量</span>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="50" class="slider" id="volumeSlider">
                        <span class="slider-value" id="volumeValue">50%</span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <span>播放模式</span>
                    <select id="musicModeSelect">
                        <option value="single">单曲循环</option>
                        <option value="list">列表循环</option>
                        <option value="random">随机播放</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <span>启用音乐</span>
                    <input type="checkbox" id="musicEnabledCheckbox" checked>
                </div>
                
                <div class="setting-item">
                    <span>音频列表</span>
                    <select id="musicSelect" class="music-select">
                        <option value="">选择音频文件...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- 主题设置内容 -->
        <div class="settings-content" id="theme-content">
            <div class="settings-section">
                <div class="section-title">主题</div>
                
                <div class="setting-item">
                    <span>主题颜色</span>
                    <select id="themeSelect">
                        <option value="default">默认</option>
                        <option value="dark">深色</option>
                        <option value="light">浅色</option>
                        <option value="blue">蓝色</option>
                        <option value="green">绿色</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <span>字体大小</span>
                    <div class="slider-container">
                        <input type="range" min="80" max="150" value="100" class="slider" id="fontSizeSlider">
                        <span class="slider-value" id="fontSizeValue">100%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 帮助面板 -->
    <div class="help-panel" id="helpPanel">
        <div class="help-header">
            <div class="help-title">使用说明</div>
            <button class="close-help" id="closeHelp">×</button>
        </div>
        <div class="help-content">
            <h3>基本操作</h3>
            <ul>
                <li><strong>开始/暂停</strong>：点击▶️按钮或双击屏幕</li>
                <li><strong>重置</strong>：点击⏹️按钮</li>
                <li><strong>切换布局</strong>：点击↕️按钮切换横竖屏布局</li>
                <li><strong>设置</strong>：点击⚙️按钮打开设置面板</li>
                <li><strong>显示/隐藏控制面板</strong>：单击屏幕任意非按钮区域</li>
                <li><strong>背景切换</strong>：在设置面板中可设置切换间隔（10秒、30秒、60秒或自定义）</li>
                <li><strong>图片选择</strong>：在设置面板的图片列表中可直接点击选择背景图片</li>
            </ul>
            
            <h3>键盘快捷键</h3>
            <ul>
                <li><strong>空格键</strong>：开始/暂停计时</li>
                <li><strong>回车键</strong>：重置计时器</li>
                <li><strong>L键</strong>：切换布局</li>
                <li><strong>S键</strong>：打开设置</li>
                <li><strong>ESC键</strong>：关闭设置或帮助</li>
                <li><strong>B键</strong>：切换背景图片</li>
                <li><strong>M键</strong>：切换音乐开关</li>
                <li><strong>H键</strong>：打开帮助</li>
            </ul>
            
            <h3>功能说明</h3>
            <p>本计时器提供全屏沉浸式体验，支持自动切换背景图片和背景音乐，可根据个人喜好调整各项设置。</p>
            
            <h3>运行模式</h3>
            <div id="modeInfo" class="mode-info">
                <p><strong>当前模式：</strong><span id="currentMode">检测中...</span></p>
                <p><strong>网络状态：</strong><span id="networkStatus">检测中...</span></p>
                <p><strong>应用状态：</strong><span id="appStatus">检测中...</span></p>
            </div>
            
            <h3>PWA功能</h3>
            <p>本应用支持PWA（渐进式Web应用），可以安装到桌面，支持离线使用。</p>
            <ul>
                <li><strong>在线模式</strong>：实时网络连接，可获取最新资源</li>
                <li><strong>离线模式</strong>：使用缓存资源，计时器功能正常</li>
                <li><strong>PWA模式</strong>：独立应用运行，体验更佳</li>
            </ul>
            <div class="pwa-install-section">
                <h4>安装到桌面</h4>
                <p>将应用安装到桌面，获得更好的使用体验：</p>
                <button id="installPWA" class="install-btn">📱 添加到桌面</button>
                <p class="install-tip">提示：在移动设备上，您也可以使用浏览器的"添加到主屏幕"功能</p>
            </div>
        </div>
    </div>

    <!-- 音频元素 -->
    <audio id="backgroundMusic" loop></audio>

    <script src="script.js"></script>

	<!-- Service Worker注册 -->
	<script>
	// 注册Service Worker以实现离线功能
	if ('serviceWorker' in navigator) {
		window.addEventListener('load', function() {
			navigator.serviceWorker.register('./sw.js')
				.then(function(registration) {
					console.log('Service Worker 注册成功: ', registration.scope);
					// Service Worker注册成功后，检查是否满足安装条件
					checkInstallability();
				})
				.catch(function(error) {
					console.log('Service Worker 注册失败: ', error);
				});
		});
	}

	let deferredPrompt = null;
	let installPromptShown = false;

	// 检测是否可安装到桌面
	window.addEventListener('beforeinstallprompt', (e) => {
		e.preventDefault();
		deferredPrompt = e;
		
		// 记录安装提示可用
		console.log('PWA安装提示可用');
		
		// 移动端：延迟显示安装提示，给用户时间熟悉应用
		if (isMobileDevice() && !installPromptShown) {
			setTimeout(() => {
				showInstallPrompt();
			}, 10000); // 10秒后显示
		}
	});

	// 检测页面可见性变化（用户可能返回页面）
	document.addEventListener('visibilitychange', () => {
		if (!document.hidden && deferredPrompt && !installPromptShown) {
			showInstallPrompt();
		}
	});

	// 检测设备是否为移动端
	function isMobileDevice() {
		return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
		   (navigator.maxTouchPoints && navigator.maxTouchPoints > 2) ||
		   window.innerWidth <= 768;
	}

	// 检查安装条件
	function checkInstallability() {
		// 检查是否已安装
		if (window.matchMedia('(display-mode: standalone)').matches) {
			console.log('应用已安装');
			return;
		}
		
		// 检查是否满足PWA安装条件
		if ('BeforeInstallPromptEvent' in window) {
			console.log('支持PWA安装');
		}
	}

	function showInstallPrompt() {
		if (deferredPrompt && !installPromptShown) {
			installPromptShown = true;
			
			// 移动端：使用更友好的提示方式
			if (isMobileDevice()) {
				showMobileInstallPrompt();
			} else {
				showDesktopInstallPrompt();
			}
		}
	}

	function showMobileInstallPrompt() {
		const installOverlay = document.createElement('div');
		installOverlay.style.cssText = `
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			z-index: 10000;
			padding: 20px;
			box-sizing: border-box;
		`;
		
		const installContent = document.createElement('div');
		installContent.style.cssText = `
			background: white;
			border-radius: 15px;
			padding: 25px;
			max-width: 320px;
			width: 90%;
			text-align: center;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
		`;
		
		installContent.innerHTML = `
			<h3 style="margin: 0 0 15px 0; color: #333;">📱 添加到桌面</h3>
			<p style="margin: 0 0 20px 0; color: #666; line-height: 1.5;">
				将应用添加到桌面，获得更好的使用体验
			</p>
			<div style="display: flex; gap: 10px; justify-content: center;">
				<button id="installNow" style="
					background: #4fc3f7;
					color: white;
					border: none;
					padding: 12px 25px;
					border-radius: 25px;
					font-size: 16px;
					cursor: pointer;
					flex: 1;
				">立即安装</button>
				<button id="installLater" style="
					background: transparent;
					color: #666;
					border: 1px solid #ddd;
					padding: 12px 25px;
					border-radius: 25px;
					font-size: 16px;
					cursor: pointer;
					flex: 1;
				">稍后再说</button>
			</div>
			<p style="margin: 15px 0 0 0; font-size: 12px; color: #999;">
				提示：在浏览器菜单中选择"添加到主屏幕"
			</p>
		`;
		
		installOverlay.appendChild(installContent);
		document.body.appendChild(installOverlay);
		
		// 立即安装按钮
		document.getElementById('installNow').onclick = async () => {
			try {
				deferredPrompt.prompt();
				const { outcome } = await deferredPrompt.userChoice;
				if (outcome === 'accepted') {
					console.log('用户接受了安装提示');
				}
			} catch (error) {
				console.log('安装提示失败:', error);
			}
			installOverlay.remove();
		};
		
		// 稍后再说按钮
		document.getElementById('installLater').onclick = () => {
			installOverlay.remove();
			// 1小时后再次显示
			setTimeout(() => {
				installPromptShown = false;
			}, 3600000);
		};
		
		// 点击遮罩层关闭
		installOverlay.onclick = (e) => {
			if (e.target === installOverlay) {
				installOverlay.remove();
			}
		};
		
		// 10秒后自动关闭
		setTimeout(() => {
			if (installOverlay.parentNode) {
				installOverlay.remove();
			}
		}, 10000);
	}

	function showDesktopInstallPrompt() {
		const installBtn = document.createElement('button');
		installBtn.textContent = '📱 添加到桌面';
		installBtn.style.cssText = `
			position: fixed;
			top: 10px;
			right: 10px;
			background: #4fc3f7;
			color: white;
			border: none;
			padding: 10px 15px;
			border-radius: 20px;
			font-size: 14px;
			z-index: 1000;
			cursor: pointer;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
		`;
		
		installBtn.onclick = async () => {
			try {
				deferredPrompt.prompt();
				const { outcome } = await deferredPrompt.userChoice;
				if (outcome === 'accepted') {
					installBtn.remove();
				}
			} catch (error) {
				console.log('安装提示失败:', error);
			}
			deferredPrompt = null;
		};
		
		document.body.appendChild(installBtn);
		
		// 30秒后自动隐藏
		setTimeout(() => {
			if (installBtn.parentNode) {
				installBtn.remove();
			}
		}, 30000);
	}
	
	// 手动触发安装提示（可用于帮助菜单）
	window.showPWAInstall = function() {
		if (deferredPrompt) {
			deferredPrompt.prompt();
		} else {
			alert('您的浏览器不支持PWA安装，或应用已安装。请使用浏览器的"添加到主屏幕"功能。');
		}
	};
	</script>

</body>
</html>